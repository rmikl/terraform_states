trigger:
- master

pool:
  vmImage: ubuntu-latest

steps:
- script: |
    curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
    sudo apt-add-repository "deb [arch=$(dpkg --print-architecture)] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
    sudo apt install -y terraform 
    curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
    az login --service-principal -u $(GITHUB_APPID) -p $(GITHUB_PASSWORD) --tenant $(GITHUB_TENANT)
    az account show | grep -i robert
  displayName: connect to azure

- task: DownloadSecureFile@1
  name: file_id_rsa
  displayName: 'download id_rsa'
  inputs:
    secureFile: 'id_rsa'

- script: |
    whoami
    sudo chown root:root $(file_id_rsa.secureFilePath)
    sudo chmod a+r $(file_id_rsa.secureFilePath)
    mkdir -p /root/.ssh
    echo -e "Host $(SHARE_IP)\n\tStrictHostKeyChecking no"
    sudo ln -s -t /root/.ssh/ $(file_id_rsa.secureFilePath)
    ssh $(SHARE_USER)@(SHARE_IP) "echo test123"
